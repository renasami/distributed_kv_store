# 分散KVストア - Raft実装プロジェクト

## プロジェクト概要

TypeScript/Node.jsを使用してRaftコンセンサスアルゴリズムに基づく分散Key-Valueストアを実装します。

## 開発原則

### 1. テスト駆動開発（TDD）

- **必ず**実装前にテストを書く
- Red-Green-Refactorサイクルを厳守
- テストカバレッジ90%以上を維持
- 開発中は`npm run test:watch`を常時実行

### 2. ドキュメント駆動開発

- コーディング前に`docs/specs/`に仕様を作成/更新
- アーキテクチャ決定記録を`docs/adr/`に保存
- README.mdを最新のプロジェクト状態に保つ

### 3. コード品質基準

- `any`型の使用禁止 - 適切なTypeScript型を使用
- 可能な限り純粋関数を使用
- Result型による明示的なエラーハンドリング
- 関数の最大行数: 30行
- ファイルの最大行数: 200行

## 重要な指示

- **すべての入出力（コメント、ログ、エラーメッセージ、ドキュメント）は日本語で記述**
- **変数名と関数名は英語を使用（TypeScriptの慣例に従う）**
- **型名とインターフェース名も英語を使用**

## プロジェクト構造

```
distributed-kv-store/
├── src/
│   ├── core/           # Raftコア実装
│   ├── consensus/      # コンセンサスアルゴリズム
│   ├── network/        # RPCとネットワーキング
│   ├── storage/        # 永続化層
│   ├── types/          # TypeScript型定義
│   └── utils/          # ユーティリティとヘルパー
├── test/
│   ├── unit/          # ユニットテスト（src/をミラー）
│   └── integration/   # 統合テスト
├── docs/
│   ├── specs/         # 仕様書
│   │   ├── technical/ # 技術仕様書
│   │   └── usecase/   # ユースケース仕様書
│   └── adr/           # アーキテクチャ決定記録
└── data/              # 実行時データ（git-ignored）
```

## コミットメッセージ規約

```
feat: 新機能を追加
fix: バグを修正
test: テストを追加または修正
docs: ドキュメントを変更
refactor: コードをリファクタリング
perf: パフォーマンスを改善
chore: メンテナンスタスク
```

## テストガイドライン

### テスト構造

```typescript
describe('コンポーネント名', () => {
  describe('メソッド名', () => {
    describe('正常系', () => {
      it('期待される動作を記述', () => {
        // 準備 -> 実行 -> 検証
      });
    });

    describe('異常系', () => {
      it('エラーケースを処理する', () => {
        // エラーハンドリングをテスト
      });
    });
  });
});
```

### テストファイル命名規則

- ユニットテスト: `*.test.ts`
- 統合テスト: `*.integration.test.ts`
- テストの場所はソースコードの場所をミラーリング

## コーディング標準

### 型定義

```typescript
// 明示的な型を使用
type NodeId = string;
type Term = number;
type LogIndex = number;

// 状態には判別可能なユニオン型を使用
type NodeState =
  | { type: 'follower'; leaderId?: NodeId }
  | { type: 'candidate' }
  | { type: 'leader' };

// エラーハンドリングにはResult型を使用
type Result<T, E> = { ok: true; value: T } | { ok: false; error: E };
```

### 関数スタイル

```typescript
// 純粋関数を推奨
export function calculateCommitIndex(
  matchIndices: readonly number[],
  currentCommit: number,
): number {
  // 実装
}

// 明示的な戻り値型
function processVote(request: VoteRequest): VoteResponse {
  // 実装
}
```

## 開発ワークフロー

1. **仕様優先**
   - `docs/specs/`に仕様を作成/更新
   - 要件をレビューして明確化

2. **テスト優先**
   - 失敗するテストを作成
   - テストが正しい理由で失敗することを確認

3. **最小限の実装**
   - テストを通す最小限のコードを作成
   - 早すぎる最適化は避ける

4. **リファクタリング**
   - コード品質を改善
   - テストが通り続けることを確認

5. **ドキュメント化**
   - 実装が異なる場合は仕様を更新
   - 複雑なロジックにはインラインコメントを追加

6. **コミット**
   - 小さく原子的なコミット
   - 明確なコミットメッセージ

## 主要アルゴリズム

### Raftコンセンサス

- **リーダー選出**: Raft論文セクション5.2に従って実装
- **ログレプリケーション**: Raft論文セクション5.3に従って実装
- **安全性**: セクション5.4のすべての安全性プロパティを保証
- **参考文献**: "In Search of an Understandable Consensus Algorithm" (Ongaro & Ousterhout)

### 重要な不変条件

1. 選出安全性: 1つのtermに最大1人のリーダー
2. ログ一致性: 異なるログの同じインデックスとtermのエントリは同じコマンドを保存
3. リーダー完全性: あるtermでコミットされたエントリは将来のリーダーのログに存在
4. ステートマシン安全性: あるインデックスにエントリを適用したサーバーがあれば、他のサーバーは同じインデックスに異なるエントリを適用しない

## パフォーマンス目標

- リーダー選出: < 500ms（典型的）
- ハートビート間隔: 50-100ms
- リクエストレイテンシ: < 10ms（p99）
- スループット: > 1000 ops/sec（3ノードクラスタ）

## エラーハンドリング戦略

- コアロジックでは例外を投げない
- 回復可能なエラーにはResult型を使用
- すべてのエラーをコンテキスト付きでログ出力
- ネットワーク障害にはサーキットブレーカーを実装
- パーティション下での優雅な劣化

## 依存関係ポリシー

- 外部依存を最小化
- 組み込みのNode.jsモジュールを優先
- 各依存が必要な理由をドキュメント化
- 既知の脆弱性がある依存は使用しない

## 現在のフェーズ: コアロジック実装

永続化やネットワークの複雑性なしにコアRaftアルゴリズムの実装に集中する。

## 日本語使用ガイドライン

- エラーメッセージ: `エラー: ノード${nodeId}への接続に失敗しました`
- ログメッセージ: `情報: リーダー選出を開始します`
- コメント: `// この関数はコミットインデックスを計算します`
- テスト説明: `it('正常にリーダーに遷移できる', () => {})`
- ドキュメント: すべて日本語で記述
